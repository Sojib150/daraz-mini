<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Econsave TPG1 Work Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 15px;
      margin: 10px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .card h3 {
      margin: 0;
      color: #111;
    }
    .card p {
      color: #666;
      margin: 5px 0;
    }
    button {
      background-color: #007bff;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 5px;
    }
    button:hover {
      background-color: #0056b3;
    }
    select {
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .record {
      background: #f0f8ff;
      margin-top: 5px;
      padding: 5px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <h1>Econsave TPG1 Work Tracker</h1>
  <div id="workerList"></div>

  <!-- Firebase -->
  <script type="module">
    // Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB6b93A_HeU4FADs3o2Ysw6-dlRRS2TbZk",
      authDomain: "telegram-miniapp-e8cc0.firebaseapp.com",
      databaseURL: "https://telegram-miniapp-e8cc0-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "telegram-miniapp-e8cc0",
      storageBucket: "telegram-miniapp-e8cc0.firebasestorage.app",
      messagingSenderId: "827930913054",
      appId: "1:827930913054:web:502b56e0c198d8e9ff410f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const workers = [
      "MOHAMMAD MASUD","RAFIUL ISLAM","ALAMIN","MIAH SOHAG","SHARIFUL ISLAM","SOJEEB MIAH",
      "DELUAR","SAJIB","MIAH RUBEL","MATANG DAH","RANA SOHAL","BAINATH YADAV","KAMESHWER",
      "RANJIT KUMAR","SANJAY KUMAR","RAI AASH BAHADUR","SAHAN UPENDRA","SAH TELI SHANKAR PRASAD",
      "RAY TEJNAYAN","AHAMMED MD SAMIM","MOHAMMED ASHRAFUL","SHEKH MD SAKIB","ISLAM MD AHANARUL",
      "BIJAYA TAMANG","THAKUR JAY PRAKASH","BOHARA LAXMAN","BHANDARI LIL MAN","BISHWAKARMA BHUPAT RAJ",
      "BISHOKARMA NOM BAHADUR","BOHARA PREM","YADAV DINESH KUMAR","BK RAJ KUMAR"
    ];

    const workOptions = [
      "Unloading goods from container",
      "Arranging goods by barcode",
      "Receiving goods",
      "Picking goods",
      "Driving forklift",
      "MC (Medical leave / sick)",
      "Store cleaning",
      "No work"
    ];

    const workerList = document.getElementById("workerList");

    workers.forEach(name => {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <h3>${name}</h3>
        <p id="status-${name}">Current Work: <i>Loading...</i></p>
        <button onclick="updateWork('${name}')">Update</button>
        <button onclick="viewDetails('${name}')">View Details</button>
        <div id="details-${name}" style="display:none;"></div>
      `;
      workerList.appendChild(div);
    });

    window.updateWork = (name) => {
      const work = prompt("Select Work:\n" + workOptions.join("\n"));
      if (!work || !workOptions.includes(work)) return alert("Invalid selection!");

      const now = new Date();
      const timestamp = now.toLocaleString();
      const newRecord = { work, time: timestamp };

      const workerRef = ref(db, "workers/" + name);
      const pushRef = push(workerRef);
      set(pushRef, newRecord);

      alert(`${name} updated to "${work}" at ${timestamp}`);
    };

    window.viewDetails = (name) => {
      const detailDiv = document.getElementById("details-" + name);
      const workerRef = ref(db, "workers/" + name);

      onValue(workerRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) {
          detailDiv.innerHTML = "<p>No records found.</p>";
          detailDiv.style.display = "block";
          return;
        }

        const entries = Object.values(data)
          .sort((a, b) => new Date(b.time) - new Date(a.time))
          .slice(0, 7); // Last 7 records

        detailDiv.innerHTML = entries.map(e =>
          `<div class='record'><strong>${e.time}</strong> â€” ${e.work}</div>`
        ).join("");

        detailDiv.style.display = "block";
      });
    };

    // Show current work
    workers.forEach(name => {
      const workerRef = ref(db, "workers/" + name);
      onValue(workerRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          const last = Object.values(data).pop();
          document.getElementById("status-" + name).innerHTML = `Current Work: <b>${last.work}</b> <br><small>${last.time}</small>`;
        } else {
          document.getElementById("status-" + name).innerHTML = "Current Work: <i>Not assigned</i>";
        }
      });
    });
  </script>
</body>
</html>
